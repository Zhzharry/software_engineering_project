# 地图加载问题诊断和解决方案

## 问题描述
高德地图（AMap）无法加载，地图容器显示空白。

## 可能的原因和解决方案

### 1. API密钥问题 ⚠️ **最常见**

#### 问题症状：
- 控制台出现 `INVALID_USER_KEY` 或 `USERKEY_PLAT_NOMATCH` 错误
- 地图容器显示空白
- 网络请求返回 403 或 401 错误

#### 解决方案：
1. **检查API密钥类型**：
   - 当前使用的密钥：`3f02caa01d89c1d4d03e88ee2259e2f7`
   - 必须使用 **Web端（JS API）** 类型的密钥
   - 不能使用服务端（Web Service）类型的密钥

2. **申请新的Web端密钥**：
   - 访问：https://console.amap.com/dev/key/app
   - 创建新应用，选择 **"Web端（JS API）"** 类型
   - 配置白名单（可选）：添加 `localhost:5173` 和 `localhost:5174`
   - 获取新的API密钥

3. **更新密钥**：
   - 在 `frontend/src/views/MapVisualization.vue` 第165行更新密钥
   ```javascript
   script.src = `https://webapi.amap.com/maps?v=2.0&key=你的新密钥&plugin=AMap.MarkerCluster,AMap.HeatMap`
   ```

### 2. 网络连接问题

#### 问题症状：
- 控制台显示脚本加载失败
- 网络请求超时

#### 解决方案：
1. **检查网络连接**：
   - 确保能访问 `https://webapi.amap.com`
   - 检查防火墙或代理设置

2. **使用CDN镜像**（如果主CDN无法访问）：
   ```javascript
   // 可以尝试使用其他CDN
   script.src = 'https://webapi.amap.com/maps?v=2.0&key=你的密钥'
   ```

### 3. 容器高度问题

#### 问题症状：
- 地图容器高度为0
- 地图不显示但控制台无错误

#### 解决方案：
1. **检查CSS样式**：
   - 确保 `.map-container` 和 `#amap-container` 有明确的高度
   - 已设置 `min-height: 600px`

2. **检查父容器**：
   - 确保父容器（Layout组件）有足够的高度
   - 检查是否有 `overflow: hidden` 导致容器被裁剪

### 4. 脚本加载顺序问题

#### 问题症状：
- AMap对象未定义
- 控制台显示 `AMap is not defined`

#### 解决方案：
- 代码已添加等待机制，确保AMap对象初始化后再创建地图
- 如果仍有问题，检查是否有其他脚本冲突

### 5. 跨域问题（CORS）

#### 问题症状：
- 控制台显示CORS错误
- 脚本加载被阻止

#### 解决方案：
- 高德地图API通常不会有CORS问题
- 如果遇到，检查浏览器安全设置

## 诊断步骤

### 步骤1：打开浏览器开发者工具
1. 按 `F12` 打开开发者工具
2. 切换到 **Console** 标签页
3. 切换到 **Network** 标签页

### 步骤2：检查控制台日志
应该看到以下日志（按顺序）：
```
开始初始化地图...
开始加载高德地图脚本...
地图脚本已添加到页面，URL: https://webapi.amap.com/...
高德地图脚本加载成功，等待AMap对象初始化...
AMap对象初始化成功，开始创建地图实例
开始创建地图实例
容器信息: {...}
地图实例创建成功
地图加载完成，开始加载数据
```

### 步骤3：检查网络请求
在 **Network** 标签页中：
1. 查找 `webapi.amap.com` 的请求
2. 检查状态码：
   - `200` - 正常
   - `403` - API密钥问题
   - `404` - URL错误
   - `0` 或 `CORS错误` - 跨域问题

### 步骤4：检查容器元素
在 **Console** 中执行：
```javascript
// 检查容器是否存在
document.getElementById('amap-container')

// 检查容器尺寸
const container = document.getElementById('amap-container')
console.log('容器尺寸:', container.offsetWidth, 'x', container.offsetHeight)

// 检查AMap对象
console.log('AMap对象:', window.AMap)
```

## 快速修复方案

### 方案1：更新API密钥（推荐）
1. 访问高德开放平台：https://console.amap.com/
2. 登录账号
3. 进入"应用管理" -> "我的应用"
4. 创建新应用，选择 **"Web端（JS API）"**
5. 获取新的API密钥
6. 更新 `MapVisualization.vue` 中的密钥

### 方案2：检查并修复容器高度
如果容器高度为0，在浏览器控制台执行：
```javascript
const container = document.getElementById('amap-container')
if (container) {
  container.style.height = '600px'
  console.log('已设置容器高度为600px')
}
```

### 方案3：清除缓存并重试
1. 清除浏览器缓存
2. 硬刷新页面（Ctrl+F5 或 Cmd+Shift+R）
3. 重新加载页面

## 常见错误代码

| 错误代码 | 含义 | 解决方案 |
|---------|------|---------|
| `INVALID_USER_KEY` | API密钥无效 | 检查密钥是否正确，是否已启用 |
| `USERKEY_PLAT_NOMATCH` | 密钥平台类型不匹配 | 使用Web端（JS API）类型的密钥 |
| `DAILY_QUERY_OVER_LIMIT` | 日调用量超限 | 升级套餐或等待次日重置 |
| `ACCESS_TOO_FREQUENT` | 访问过于频繁 | 降低请求频率 |

## 测试API密钥是否有效

在浏览器控制台执行：
```javascript
// 测试API密钥
fetch('https://webapi.amap.com/maps?v=2.0&key=你的密钥')
  .then(res => console.log('状态码:', res.status))
  .catch(err => console.error('错误:', err))
```

如果返回 200，说明密钥有效；如果返回 403，说明密钥无效或类型不匹配。

## 联系支持

如果以上方案都无法解决问题：
1. 检查高德开放平台的状态：https://status.amap.com/
2. 查看高德地图API文档：https://lbs.amap.com/api/javascript-api/summary
3. 联系高德技术支持

